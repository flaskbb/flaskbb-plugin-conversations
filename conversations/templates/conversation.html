{% extends theme("message_layout.html") %}

{% block message_content %}
{# quick check if the conversation is a draft #}
{% if conversation.draft %}
    {% set messages = [conversation.first_message] %}
{% else %}
    {% set messages = conversation.messages %}
{% endif %}
{% from theme("_macros/utils.html") import avatar_img %}
<div class="card conversation">
    <div class="card-header conversation-header">
        <div class="d-flex align-items-center">
            <div class="position-relative">
                <img src="{{ url_for('static', filename='avatar80x80.png') }}" class="rounded-circle me-1" alt="Sharon Lessman" width="40" height="40">
            </div>
            <div class="flex-grow-1 ps-3">
                {% if conversation.to_user %}
                    <div class="author-title fw-bold">{{ conversation.to_user.username }}</div>
                {% else %}
                    <div class="author-title fw-bold">{% trans %}Deleted User{% endtrans %}</div>
                {% endif %}

                {% if conversation.to_user|is_online %}
                <div class="author-online badge bg-success">online</div>
                {% else %}
                <div class="author-offline badge bg-danger">offline</div>
                {% endif %}
            </div>
            <div>
                <button class="btn btn-light border btn-lg px-3">...</button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="d-flex flex-column">
            {% for message in messages %}

            {# you #}
            {% if current_user.id == message.user_id %}
            <div class="d-flex flex-row-reverse ms-auto pb-3">
                <div class="ms-3">
                    <span data-bs-toggle="tooltip" title="You">{{ avatar_img(message.user, class="rounded-circle", size="40") }}</span>
                    <div class="text-muted small text-nowrap mt-2">{{ message.date_created|format_datetime }}</div>
                </div>

                <div class="flex-shrink-1 bg-light rounded py-2 px-3 w-75">
                    <div class="fw-bold mb-1">You</div>
                    <div class="chat-message">
                    {{ message.message|markup }}
                    </div>
                </div>
            </div>

            {# recieving person #}
            {% else %}
            <div class="d-flex flex-shrink-0 me-auto pb-4">
                <div class="me-3">
                    <span data-bs-toggle="tooltip" title="{{ message.user.username }}">{{ avatar_img(message.user, class="rounded-circle", size="40") }}</span>
                    <div class="text-muted small text-nowrap mt-2">{{ message.date_created|format_datetime }}</div>
                </div>
                <div class="flex-shrink-1 bg-light rounded py-2 px-3 w-75">
                    <div class="fw-bold mb-1">{{ message.user.username }}</div>
                    <div class="chat-message">
                    {{ message.message|markup }}
                    </div>
                </div>
            </div>
            {% endif %}

            {% endfor %}
        </div>
    </div>

    <div class="flex-grow-0 py-3 px-4 border-top">

{% if not conversation.draft and conversation.from_user != None and conversation.to_user != None %}
{% from "_macros/form.html" import render_input_field, render_submit_field %}
<form action="#" method="post">
    {{ form.hidden_tag() }}
    <div class="row conversation-reply">
        <div class="col-12">
            {{ render_input_field(form.message, required="required") }}

            {{ render_input_field(form.submit, div_class="mt-3", class="btn btn-success") }}
        </div>
    </div>
</form>
{% endif %}


        <div class="input-group">
            <input type="text" class="form-control" placeholder="Type your message">
            <button class="btn btn-primary">Send</button>
        </div>
    </div>
</div>


</div>



{% endblock %}
